{% extends "layout.html" %}
{% block title %}Projections{% endblock %}
{% block page %}Projections{% endblock %}

{% block styles %}
    <style>
        /* Add any additional styles here if needed */
        .input-field{
          margin-bottom: 0;
        }
    </style>
{% endblock %}

{{ super() }}

{% block content %}
<main style="padding: 0;">
    <div class="row">
        <!-- Input Column -->
        <div class="col s12 m3">
            <div >
            <h5>Enrolment Projection</h5>
            <form id="enrolment-form">
                <div class="input-field">
                <input type="number" id="cs_special" name="cs_special" min="0">
                <label for="cs_special">CS Special</label>
                </div>
                <div class="input-field">
                <input type="number" id="it_special" name="it_special" min="0">
                <label for="it_special">IT Special</label>
                </div>
                <div class="input-field">
                <input type="number" id="it_major" name="it_major" min="0">
                <label for="it_major">IT Major</label>
                </div>
                <div class="input-field">
                <input type="number" id="cs_major" name="cs_major" min="0">
                <label for="cs_major">CS Major</label>
                </div>
                <div class="input-field">
                <input type="number" id="cs_mgmt" name="cs_mgmt" min="0">
                <label for="cs_mgmt">CS &amp; Mgmt</label>
                </div>
                <div class="input-field">
                <input type="number" id="cs_minor" name="cs_minor" min="0">
                <label for="cs_minor">CS Minor</label>
                </div>
                <div class="input-field">
                <input type="number" id="it_minor" name="it_minor" min="0">
                <label for="it_minor">IT Minor</label>
                <div id="optimize-spinner" style="display:none;justify-content:center;align-items:center;height:60px;">
                <div class="preloader-wrapper active" style="width:40px;height:40px;">
                  <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                  </div>
                </div>
                <span style="margin-left:10px;">Optimizing...</span>
              </div>
                </div>
                <button type="button" class="btn blue" style="width:100%;margin-bottom:10px;">Project</button>
                <button type="button" class="btn green" style="width:100%;">Optimize</button>
            </form>
            </div>
        </div>

        <!-- Stats & Charts Column -->
        <div class="col s12 m9">
            <div class="row">
            <!-- Card Grid: 2 rows x 3 columns -->
            <!-- Past Year Row -->
            <div class="col s12 m4">
                <div class="card-panel blue lighten-1 white-text center">
                <h6>Past Year</h6>
                <p>Marking Expenditure</p>
                <div>
                    <span>Sem 1: <strong>$12,500</strong></span><br>
                    <span>Sem 2: <strong>$13,200</strong></span>
                </div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card-panel blue lighten-1 white-text center">
                <h6>Past Year</h6>
                <p>Staff Workload</p>
                <div id="workload-pie" style="height:120px;"></div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card-panel blue lighten-1 white-text center">
                <h6>Past Year</h6>
                <p>Student Performance</p>
                <div id="cohort-performance" style="height:120px;"></div>
                <div style="font-size: 0.9em;">
                    <span>Level 1 Aggregate Avg Grade: 78</span><br>
                    <span>Level 2 Aggregate Avg Grade: 74</span><br>
                    <span>Level 3 Aggregate Avg Grade: 70</span>
                </div>
                </div>
            </div>
            <!-- Projected Row -->
            <div class="col s12 m4">
                <div class="card-panel teal lighten-1 white-text center">
                <h6>Projected</h6>
                <p>Marking Expenditure</p>
                <div>
                    <span>Sem 1: <strong id="proj-sem1">$--</strong></span><br>
                    <span>Sem 2: <strong id="proj-sem2">$--</strong></span>
                </div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card-panel teal lighten-1 white-text center">
                <h6>Projected</h6>
                <p>Staff Workload</p>
                <div id="workload-pie-proj" style="height:120px;"></div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card-panel teal lighten-1 white-text center">
                <h6>Projected</h6>
                <p>Student Performance</p>
                <div id="cohort-performance-proj" style="height:120px;"></div>
                <div style="font-size: 0.9em;">
                    <span>Level 1 Aggregate Avg Grade: <span id="gpa1">--</span></span><br>
                    <span>Level 2 Aggregate Avg Grade: <span id="gpa2">--</span></span><br>
                    <span>Level 3 Aggregate Avg Grade: <span id="gpa3">--</span></span>
                </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Highcharts CDN -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script>
    // Past Year Staff Workload Pie (with staff names)
    Highcharts.chart('workload-pie', {
      chart: { type: 'pie', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      legend: { enabled: false },
      plotOptions: { pie: { dataLabels: { enabled: true } } },
      series: [{
        name: 'Workload',
        data: [
          { name: 'Alana Mano', y: 30 },
          { name: 'Jeff Burke', y: 25 },
          { name: 'Susan Williams', y: 20 },
          { name: 'Larry Watters', y: 25 }
        ]
      }]
    });

    // Past Year Cohort Performance Bar
    Highcharts.chart('cohort-performance', {
      chart: { type: 'column', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      xAxis: { categories: ['Level 1', 'Level 2', 'Level 3'] },
      yAxis: { min: 0, max: 100, title: { text: 'Aggregate Avg Grade' } },
      legend: { enabled: false },
      series: [{
        name: 'Aggregate Avg Grade',
        data: [78, 74, 70],
        colorByPoint: true
      }]
    });

    // Projected Staff Workload Pie (with staff names)
    let projWorkloadChart = Highcharts.chart('workload-pie-proj', {
      chart: { type: 'pie', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      legend: { enabled: false },
      plotOptions: { pie: { dataLabels: { enabled: true } } },
      series: [{
        name: 'Workload',
        data: [

        ]
      }]
    });

    // Projected Cohort Performance Bar (initially blank)
    Highcharts.chart('cohort-performance-proj', {
      chart: { type: 'column', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      xAxis: { categories: ['Level 1', 'Level 2', 'Level 3'] },
      yAxis: { min: 0, max: 100, title: { text: 'Aggregate Avg Grade' } },
      legend: { enabled: false },
      series: [{
        name: 'Aggregate Avg Grade',
        data: [null, null, null],
        colorByPoint: true
      }]
    });

 // Helper to show/hide form fields and spinner
  function toggleFormFields(showFields) {
    const form = document.getElementById('enrolment-form');
    const fields = form.querySelectorAll('.input-field, .btn.blue');
    const spinner = document.getElementById('optimize-spinner');
    fields.forEach(f => f.style.display = showFields ? '' : 'none');
    if (spinner) spinner.style.display = showFields ? 'none' : 'flex';
  }

  // Add spinner to the form (hidden by default)
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('enrolment-form');
    if (!document.getElementById('optimize-spinner')) {
      const spinnerDiv = document.createElement('div');
      spinnerDiv.id = 'optimize-spinner';
      spinnerDiv.style.display = 'none';
      spinnerDiv.style.justifyContent = 'center';
      spinnerDiv.style.alignItems = 'center';
      spinnerDiv.style.height = '60px';
      spinnerDiv.innerHTML = `
        <div class="preloader-wrapper active" style="width:40px;height:40px;">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left"><div class="circle"></div></div>
            <div class="gap-patch"><div class="circle"></div></div>
            <div class="circle-clipper right"><div class="circle"></div></div>
          </div>
        </div>
        <span style="margin-left:10px;">Optimizing...</span>
      `;
      form.appendChild(spinnerDiv);
    }
  });

  // Project button (already implemented)
  document.querySelector('.btn.blue').onclick = function() {
    document.getElementById('proj-sem1').innerText = "$14,000";
    document.getElementById('proj-sem2').innerText = "$14,800";
    document.getElementById('gpa1').innerText = "80";
    document.getElementById('gpa2').innerText = "76";
    document.getElementById('gpa3').innerText = "72";
    Highcharts.chart('cohort-performance-proj', {
      chart: { type: 'column', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      xAxis: { categories: ['Level 1', 'Level 2', 'Level 3'] },
      yAxis: { min: 0, max: 100, title: { text: 'Aggregate Avg Grade' } },
      legend: { enabled: false },
      series: [{
        name: 'Aggregate Avg Grade',
        data: [80, 76, 72],
        colorByPoint: true
      }]
    });
    projWorkloadChart.update({
      series: [{
        name: 'Workload',
        data: [
          { name: 'Alana Mano', y: 28 },
          { name: 'Jeff Burke', y: 32 },
          { name: 'Susan Williams', y: 20 },
          { name: 'Larry Watters', y: 20 }
        ]
      }]
    }, true, true, false);
  };

document.querySelector('.btn.green').onclick = function() {
  // Hide fields and show spinner
  toggleFormFields(false);

  // Simulate optimization delay
  setTimeout(function() {
    // Auto-populate fields with optimized values
    document.getElementById('cs_special').value = 135;
    document.getElementById('it_special').value = 120;
    document.getElementById('it_major').value = 110;
    document.getElementById('cs_major').value = 105;
    document.getElementById('cs_mgmt').value = 70;
    document.getElementById('cs_minor').value = 55;
    document.getElementById('it_minor').value = 45;

    // Update input labels (Materialize requirement)
    M.updateTextFields();

    // Update projected figures with "better" values
    document.getElementById('proj-sem1').innerText = "$13,200";
    document.getElementById('proj-sem2').innerText = "$13,900";
    document.getElementById('gpa1').innerText = "85";
    document.getElementById('gpa2').innerText = "80";
    document.getElementById('gpa3').innerText = "77";
    Highcharts.chart('cohort-performance-proj', {
      chart: { type: 'column', backgroundColor: 'transparent', height: 120 },
      title: { text: null },
      xAxis: { categories: ['Level 1', 'Level 2', 'Level 3'] },
      yAxis: { min: 0, max: 100, title: { text: 'Aggregate Avg Grade' } },
      legend: { enabled: false },
      series: [{
        name: 'Aggregate Avg Grade',
        data: [85, 80, 77],
        colorByPoint: true
      }]
    });
    projWorkloadChart.update({
      series: [{
        name: 'Workload',
        data: [
          { name: 'Alana Mano', y: 25 },
          { name: 'Jeff Burke', y: 28 },
          { name: 'Susan Williams', y: 22 },
          { name: 'Larry Watters', y: 25 }
        ]
      }]
    }, true, true, false);

    // Show fields and hide spinner
    toggleFormFields(true);
  }, 1200); // 1.2s spinner delay
};
  </script>
{%endblock %}